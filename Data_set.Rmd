---
title: "Data set"
author: "Julia Annika Ferdin"
date: "2025-05-04"
output: html_document
---
**************************************************************************************************************
Mass spectrometry analysis of non-synchronized HeLa cells
**************************************************************************************************************

Script is divided into different parts:
1 - Read dataset, normalization between replicated, sliding window?, normalization to sum = 100
2 - Find local maxima greater than 2 as fit parameters
3 - Gaussian fit on each curve (per protein, three control and three Rnase replicates)
4 - Quality control of fit an if possible adjustment
5 - Asses p-values and FDR-adjusted p-values for each maximum
6 - Evaluate shifts by using selection criteria
7 - Compute final table and export as csv file
Graphics 1 - Average curves for one protein of interest - function curves_plot
Graphics 2 - All curves for one protein of interest- function curves_all


**************************************************************************************************************
1 - Read dataset, normalization between replicated, sliding window?, normalization to sum = 100
**************************************************************************************************************

```{r}
#Reads table, by indicating path to directory where the dataset is stored, and stores it to variable NS_Table (NS for Non-synchronizied HeLa-cells)

NS_Table <- read.table("Daten/Data, copy but dont open.csv", header=TRUE, row.names=1, sep = ";")
```

```{r}
#The first 12 titles of the table (NS_Table) rows/colums are read out

#Row names are protein names
head(rownames(NS_Table),12)

#Columns indicate the respective fractions from 1 to 25, and their replicated
head(colnames(NS_Table),12)
```

**************************************************************************************************************
Rearrange and reorder the columns to their fraction and treatment to simplify the following work steps. 

Creating 3 vectors that describe the characteristics of the columns (i.e., samples) in the data set:
levels_CR → indicates whether the sample was treated with RNASE or as a CTRL
levels_fraction → labels the column with the replicate number (1–3) for either CTRL or RNASE
fraction_names → creates the variables fraction1 to fraction25 to assign the replicates to each fraction

```{r}
#A vector consists of 2 variables (CTRL, RNASE) --> c("CTRL", "RNASE")
#The factor() function encodes a vector as a factor. The 2 variables CTRL and RNASE are ordered into 2 different levels (characters)
#rep(vector,75) repeats the factor() function 75 times, because we have 150 columns (75 times CTRL and RNASE)
#The factor is defined as the variable 'treatment'

levels_CR <- factor(rep(c("CTRL", "RNASE"),75))
```

```{r}
#Every sample of every fraction gets its own level to disconnect them from each other -> 6 levels per fraction because we have 3 CTRLs and 3 RNASEs per fraction

levels_fraction <- factor(rep(c("Ctrl_Rep1","RNase_Rep1","Ctrl_Rep2","RNase_Rep2","Ctrl_Rep3","RNase_Rep3"),25))
View(levels_fraction)
```

```{r}
# Creation of a matrix with 6 rows and 25 columns. The matrix is filled by row from fraction1 to fraction25 so every column has one single fraction.
# sep="" compares the word fraction with the numbers 1 to 25 without a blank space.
# paste("fraction",1:25,sep="") creates a vector with the strings fraction1 to fraction25
# as.vector changes the created matrix into a vector with 150 elements sorted from 6 times fraction1 to 6 times fraction25

fraction_names <- as.vector(matrix(rep(paste("fraction",1:25,sep=""),6), nrow = 6, ncol=25, byrow = TRUE))

View(matrix(rep(paste("fraction",1:25,sep=""),6), nrow = 6, ncol=25, byrow = TRUE))
```

```{r}
# The number of rows are stored in a variable
n_row <- nrow(NS_Table)

# The row names (protein names) are stored in a variable
row_names <- rownames(NS_Table)
```

```{r}
# Creation of a data frame with levels_CR, levels_fraction and fraction_names. This assigns every replicate of the factions (levels_fraction) to their fraction (fraction_names) and their kind of treatment, CRTL or RNASE (levels_CR).

colmns_sorted <- data.frame(row.names = colnames(NS_Table), levels_CR = levels_CR, levels_fraction = levels_fraction, fraction_names = fraction_names)

View(colmns_sorted)

#Check for missing values, there are none 
anyNA(NS_Table)
```


**************************************************************************************************************
Normalization step between the replicates in each fraction and for each treatment using the mean value method

```{r}
# lapply executes for every with paste  created string (the fractions) a function fx
# colmns_sorted$fraction == fx: checks which columns are part of the fractions fx
# NS_Table[, ...] filters just these columns and assigns them to the list "fraction.tables"
# names(fraction.tables): the list "fraction.tables" gets names for its segments and assigns them to the variable selected_proteins 

fraction.tables <- lapply(paste("fraction", 1:25, sep = ""), function(fx) {NS_Table[, colmns_sorted$fraction == fx]})

names(fraction.tables) <- paste("fraction", 1:25, sep = "")

selected_proteins <- names(fraction.tables)
```


```{r}
# List with just CTRL/RNASE columns for each fraction
# subset filters just the fractions that fulfill the conditions: fraction_names == fx --> fraction name is part of the funtion fx, levels_CR == "CTRL" --> protein was treated as a CTRL
# rownames() takes the rownames of the filtert fractions and asigns them to the variable col
# NS_Table[, cols, drop = FALSE] the names that are part of NS_Table are filterd out and drop = FALSE makes sure that fraction.tables.CTRL will be a dataframe

# Liste mit nur CTRL-Spalten für jede Fraktion
fraction.tables.CTRL <- lapply(selected_proteins, function(fx) {
  cols <- rownames(subset(colmns_sorted, fraction_names == fx & levels_CR == "CTRL")) 
  NS_Table[, cols, drop = FALSE]
  })

# Liste mit nur RNASE-Spalten für jede Fraktion
fraction.tables.RNASE <- lapply(selected_proteins, function(fx) {
  cols <- rownames(subset(colmns_sorted, fraction_names == fx & levels_CR == "RNASE"))
  NS_Table[, cols, drop = FALSE]})

names(fraction.tables.CTRL) <- selected_proteins
names(fraction.tables.RNASE) <- selected_proteins

View(fraction.tables.CTRL[["fraction3"]])
```

```{r}
# sapply(df, mean) calculates the mean of every column of the dataframe fraction.tables.CTRL

avg.tables.CTRL <- lapply(fraction.tables.CTRL, function(df) {
  sapply(df, mean)
})

avg.tables.RNASE <- lapply(fraction.tables.RNASE, function(df) {
  sapply(df, mean)
})

avg.tables.CTRL[["fraction1"]]
avg.tables.RNASE[["fraction1"]]
```
```{r}
#--> prinzpiell wird mit diesem Code gesagt, dass mindestens 1 Wert immer ein Messfehler sein muss, müssen wir uns überlegen, ob wir das genauso machen wollen oder ob wir alle 3 Messwerte mit einbeziehen.
# Determine normalization factor for each condition (i.e. sample), as the mean of the 2 most similar replicates.
# Create a function norm_fact for this step:

norm_fact <- function(x) {
				if( (abs(x[1]-x[2])<abs(x[1]-x[3])) && (abs(x[1]-x[2])<abs(x[2]-x[3])) ) 
					{mean(c(x[1],x[2]))} else if( (abs(x[1]-x[3])<abs(x[1]-x[2])) && (abs(x[1]-x[3])<abs(x[2]-x[3])) )
												  {mean(c(x[1],x[3]))} else {mean(c(x[2],x[3]))} 
}


print(norm_fact(avg.tables.CTRL[["fraction1"]]))
```

```{r}
# normalization of the mean value vectors - inversely proportional to the size of the values
# norm_factor / vec: gives a new vector indicating how strong each element is relative to the norm factor (mean)

norm_mean_frxn_CTRL <- lapply(avg.tables.CTRL, function(vec) {
  norm_factor <- norm_fact(vec)
  norm_factor / vec 
})

norm_mean_frxn_RNASE <- lapply(avg.tables.RNASE, function(vec) {
  norm_factor <- norm_fact(vec)
  norm_factor / vec 
})

print(norm_mean_frxn_CTRL[[1]])
```


```{r}
# Correction factor for the overall protein quantity
# Normalization vectors for replicates 1-3
# function(x) x[1]: extracts the first element of each vector in the list
# norm.ctrl1 is a numeric vector consisting of the 1st element of each normalized CTRL vector

norm.ctrl1 <- sapply(norm_mean_frxn_CTRL, function(x) x[1])
norm.ctrl2 <- sapply(norm_mean_frxn_CTRL, function(x) x[2])
norm.ctrl3 <- sapply(norm_mean_frxn_CTRL, function(x) x[3])

norm.rnase1 <- sapply(norm_mean_frxn_RNASE, function(x) x[1])
norm.rnase2 <- sapply(norm_mean_frxn_RNASE, function(x) x[2])
norm.rnase3 <- sapply(norm_mean_frxn_RNASE, function(x) x[3])
```

```{r}
# Defines logical vectors (TRUE, FALSE), which are later used to create subtables - separately for treatment (Ctrl vs. RNase) and replica (Rep1, Rep2, Rep3)
# colmns_sorted$levels_fraction =="Ctrl_Rep1": checks at which position exactly in the columns_sorted Ctrl_Rep1 can be found (marks it with TRUE)

data.ctrl1 <- colmns_sorted$levels_fraction =="Ctrl_Rep1"
data.ctrl2 <- colmns_sorted$levels_fraction =="Ctrl_Rep2"
data.ctrl3 <- colmns_sorted$levels_fraction =="Ctrl_Rep3"
data.rnase1 <- colmns_sorted$levels_fraction =="RNase_Rep1"
data.rnase2 <- colmns_sorted$levels_fraction =="RNase_Rep2"
data.rnase3 <- colmns_sorted$levels_fraction =="RNase_Rep3"
```

**************************************************************************************************************
```{r}
# Normalization step, fraction-wise
# takes specific columns from the protein intensity table and scales each row according to a normalization factor to compensate for measurement differences between replicates
# mask: A logical vector (TRUE/FALSE) that specifies which columns of NS_Table are selected
# selected <- NS_Table[, mask]: from NS_Table only the columns marked with TRUE in mask are selected
# (`*`, selected, norm_vec, SIMPLIFY = FALSE): Multiplication of colums of selected and the vector norm_vec saved as a list

normalize_group <- function(mask, norm_vec) {
  selected <- NS_Table[, mask]                  
  as.data.frame(mapply(`*`, selected, norm_vec, SIMPLIFY = FALSE))
}

# logical vectors (data.ctrl1) and vectors with normalization-factors (norm.ctrl1) form groups
# normalize_group(): multiplication of the vectors with their normalization-factor

table.ctrl1  <- normalize_group(data.ctrl1,  norm.ctrl1)
table.ctrl2  <- normalize_group(data.ctrl2,  norm.ctrl2)
table.ctrl3  <- normalize_group(data.ctrl3,  norm.ctrl3)
table.rnase1 <- normalize_group(data.rnase1, norm.rnase1)
table.rnase2 <- normalize_group(data.rnase2, norm.rnase2)
table.rnase3 <- normalize_group(data.rnase3, norm.rnase3)

```

```{r}
# Get the proper rownames for the tables

rownames(table.ctrl1) <- row_names
rownames(table.ctrl2) <- row_names
rownames(table.ctrl3) <- row_names
rownames(table.rnase1) <- row_names
rownames(table.rnase2) <- row_names
rownames(table.rnase3) <- row_names

View(table.ctrl1)
```

**************************************************************************************************************
```{r}
# Apply a sliding window/moving average of 3 points to the data to reduce noise in the data and obtain smoother curves (not possible for fraction 1 and 25)

smooth_table <- function(tbl) {
  data.frame(tbl[1], (tbl[1:23] + tbl[2:24] + tbl[3:25]) / 3, tbl[25])
}

table.ctrl1.SW <- smooth_table(table.ctrl1)
table.ctrl2.SW <- smooth_table(table.ctrl2)
table.ctrl3.SW <- smooth_table(table.ctrl3)
table.rnase1.SW <- smooth_table(table.rnase1)
table.rnase2.SW <- smooth_table(table.rnase2)
table.rnase3.SW <- smooth_table(table.rnase3)
```

```{r}
# Get the proper rownames for the tables

colnames(table.ctrl1.SW) <- colnames(table.ctrl1)
colnames(table.ctrl2.SW) <- colnames(table.ctrl2)
colnames(table.ctrl3.SW) <- colnames(table.ctrl3)
colnames(table.rnase1.SW) <- colnames(table.rnase1)
colnames(table.rnase2.SW) <- colnames(table.rnase2)
colnames(table.rnase3.SW) <- colnames(table.rnase3)

View(table.ctrl1.SW)
```

**************************************************************************************************************
```{r}
# Normalization of the fractions: Sum of all fraction values equals 100 (%)

normalize_table <- function(tbl) {
  tbl * 100 / rowSums(tbl)
}


tables.ctrl <- list(
  ctrl1 = table.ctrl1.SW,
  ctrl2 = table.ctrl2.SW,
  ctrl3 = table.ctrl3.SW)

tables.rnase <- list(
  rnase1 = table.rnase1.SW,
  rnase2 = table.rnase2.SW,
  rnase3 = table.rnase3.SW)

# Calculation of the percentages of the fractions in the normalized table (table.ctrl1.SW)

norm_tables.ctrl <- lapply(tables.ctrl, normalize_table)
norm_tables.rnase <- lapply(tables.rnase, normalize_table)

norm_tables.rnase$rnase1
```

**************************************************************************************************************
```{r}
# Function for replacing NA and NaN with 0

clean_table <- function(tbl) {
  tbl <- rapply(tbl, function(x) ifelse(is.na(x), 0, x), how = "replace")
  tbl <- rapply(tbl, function(x) ifelse(is.nan(x), 0, x), how = "replace")
  return(tbl)
}

#tables.norm.ctrl <- list(
#  ctrl1 = table.ctrl1.SW.norm,
#  ctrl2 = table.ctrl2.SW.norm,
#  ctrl3 = table.ctrl3.SW.norm)

#tables.norm.rnase <- list(
#  rnase1 = table.rnase1.SW.norm,
#  rnase2 = table.rnase2.SW.norm,
#  rnase3 = table.rnase3.SW.norm)

# Getting the clean table

tables.norm.ctrl <- lapply(norm_tables.ctrl, clean_table)
tables.norm.rnase <- lapply(norm_tables.rnase, clean_table)

#View(tables.norm.ctrl$ctrl1)

```

**************************************************************************************************************
```{r}
my.list.ctrl.norm <- list(table.ctrl1.SW, table.ctrl2.SW, table.ctrl3.SW)
my.list.rnase.norm <- list(table.rnase1.SW, table.rnase2.SW, table.rnase3.SW)

# Addition of all data-frames in the list my.list.ctrl.norm (element-wise) and Division of the Sum with 3 to get the mean of all 3 replicates

ctrl_norm_mean <- Reduce("+", my.list.ctrl.norm)/length(my.list.ctrl.norm)
rnase_norm_mean <- Reduce("+", my.list.rnase.norm)/length(my.list.rnase.norm)
```

```{r}
# Change names of the columns: from "fraction1" to "fraction25"

col_fractions <- paste("fraction",1:25,sep="")
colnames(ctrl_norm_mean) <- col_fractions
colnames(rnase_norm_mean) <- col_fractions
```

```{r}
# second normalization of the fractions (mean destroyed first normalization): Sum of all fraction values equals 100 (%)

ctrl_norm_mean <- ctrl_norm_mean*100/rowSums(ctrl_norm_mean)
rnase_norm_mean <- rnase_norm_mean*100/rowSums(rnase_norm_mean)

```

```{r}
# Function for replacing NA and NaN with 0

replace_na_nan <- function(x) rapply(x, function(y) ifelse(is.na(y) | is.nan(y), 0, y), how = "replace")

ctrl_norm_mean <- replace_na_nan(ctrl_norm_mean)
rnase_norm_mean <- replace_na_nan(rnase_norm_mean)
```

```{r}
# If a curve is 0 in all fractions, the other fraction is also set to 0 and is excluded from the analysis

ctrl_norm_mean[rowSums(rnase_norm_mean[1:25])==0,] <- 0
rnase_norm_mean[rowSums(ctrl_norm_mean[1:25])==0,] <- 0

View(ctrl_norm_mean)
View(rnase_norm_mean)
```

Weiter hab ich noch nicht den Code bearbeitet 
LG Ben

**************************************************************************************************************
2 - Find local maxima greater than 2 as fit parameters
**************************************************************************************************************
#### Find local maxima in each protein mean profile (peak calling step - function find_peaks) ####
# Restriction to values above an absolut threshold of 2 (to get rid of the noise)
# Identify also shoulders not found by peak calling

**************************************************************************************************************

```{r}
#Function find_peaks
#Peak is local maximum with "window" points on each side being smaller than it
#Bigger window =>more stringent peak finding procedure 

find_peaks <- function(x, window = 2) {
  slope_changes <- diff(sign(diff(x)))
  peak_indices <- which(slope_changes < 0)

  peaks <- c()

  for (i in peak_indices) {
    left <- max(1, i - window + 1)
    right <- min(length(x), i + window + 1)

    neighbors <- c(x[left:i], x[(i + 2):right])

    if (all(neighbors <= x[i + 1])) {
      peaks <- c(peaks, i + 1)
    }
  }

  return(peaks)
}

#Test, ob die Peak-Positionen richtig ausgegeben werden
probe = c(3, 5, 7, 9, 3, 10, 5, 20, 20, 4, 2, 1, 1)
find_peaks(probe)


```


```{r}
 # part added to deal with plateaux
     n = length(pks)
     if (n>1) {
     			rem <- numeric(0)
     			for (i in 1:(n-1)) { if  ((pks[i]+1) == pks[(i+1)]) {rem <- c(rem, pks[i+1]) } }
     			for (i in 1:(n-1)) { if  ((pks[i]+2) == pks[(i+1)]) {rem <- c(rem, pks[i+1]) } }
     			pks <- pks[! pks %in% rem]
     		  }	
```

```{r}
# part added to deal with the 1st and 25th values, in case they are max
     if ( sum(x[1]>x[2:(m+1)]) == 2 ) {pks <- c(pks, 1)} 
     if ( sum(x[25]>x[24:(25-m)]) == 2 ) {pks <- c(pks, 25)}
     pks <- unlist(pks)
     pks
}
```

***********************************************************************************************************
```{r}
# Apply the function to the data set and retrieve the values
# restriction to values above an absolut threshold of 2%
# New column: "maxima" (column 26)

ctrl_norm_mean$maxima <- apply(ctrl_norm_mean, 1, function(x) {
															   list <- find_peaks(x)
															   list <- list[x[list] > 2] 
															   list <- unlist(list)
															   list
															   })
															   
rnase_norm_mean$maxima <- apply(rnase_norm_mean, 1, function(x) {
															   list <- find_peaks(x)
															   list <- list[x[list] > 2] 
															   list <- unlist(list)
															   list
															   })
```

***********************************************************************************************************
# Step to retrieve the so-called "shoulder" - Group of fraction where there is a larger amount of protein that was not identified as "maxima" using the function "find_peaks"

```{r}
# Get fractions where (RNASE fraction value > 2%). Dataframe with 0/1 and RNASE maxima
# Define new tables called ctrl_3 and rnase_3 that will be used temporary
rnase_3 <- rnase_norm_mean
rnase_3[1:25] <- (rnase_norm_mean[1:25] > 2)*1


# Get fractions where (CTRL fraction value > 2%). Dataframe with 0/1 and CTRL maxima
ctrl_3 <- ctrl_norm_mean
ctrl_3[1:25] <- (ctrl_norm_mean[1:25] > 2)*1
```

```{r}
# Remove regions around maxima (3 fractions) in order not to identify those regions as "shoulder"
th_max_reg <- function(x) {
							ls <- as.numeric(unlist(x$maxima))
							n <- length(ls)
							dt <- as.data.frame(matrix(rep(1,25),1,25))
							if (n == 0) {dt[1:25] = 1} else {
							for (i in 1:n) { 
											if (ls[i] < 1) {dt[1:25] = 1}
											else if (ls[i] == 1) {dt[1:4] = 0}
											else if (ls[i] == 2) {dt[1:5] = 0}
											else if (ls[i] == 3) {dt[1:6] = 0}
											else if (ls[i] == 4) {dt[1:7] = 0}
											else if (ls[i] == 5) {dt[1:8] = 0}
											
											else if (ls[i]>=6  && ls[i]<=20) {dt[(ls[i]-3):(ls[i]+3)] = 0}
											
											else if (ls[i] == 21) {dt[18:24] = 0}
											else if (ls[i] == 22) {dt[19:25] = 0}
											else if (ls[i] == 23) {dt[20:25] = 0}
											else if (ls[i] == 24) {dt[21:25] = 0}
											else {dt[22:25] = 0}
											}
														   }	
							x[1:25] <- x[1:25]*dt
							x <- unlist(x)
							x[1:25]
						  }

rnase_3[1:25] <- t(apply( rnase_3, 1, function(x) {th_max_reg(x)} ))
ctrl_3[1:25] <- t(apply( ctrl_3, 1, function(x) {th_max_reg(x)} ))
```

```{r}
# Get the regions (marked with 1, at least 4 consecutive fractions) and select the middle of it
# Use the function rle -> $lengths and $values
# Apply on the whole dataframe

peaks_reg <- function(x) {
							res <- rle(as.numeric(x[1:25]))
							pos_res <- which(res$lengths>=4 & res$values==1)
							if (length(pos_res) == 0) {
														vct <- numeric(0)
														}
							else {							
								vct <- numeric(0)
								for (i in 1:length(pos_res)) { vct <- c( vct,   sum(res$lengths[1:pos_res[i]]) - as.integer(res$lengths[pos_res[1]]/2) ) }
								  }
								  
							vct <- unlist(vct)
							vct
						 }
```

```{r}
# get the "shoulders" in the curves
# New column: "peaks" (column 27)

rnase_3$peaks <- apply(rnase_3, 1, function(x) { peaks_reg(x) } )
ctrl_3$peaks <- apply(ctrl_3, 1, function(x) { peaks_reg(x) } )

```

***********************************************************************************************************
```{r}
# Get the list of all maxima (maxima and peaks) for RNASE and CTRL
# New column: "ctrl_max" and "rnase_max" (column 28) respectively

						   						
rnase_3$rnase_max <- apply(rnase_3, 1, function(x) {
												 ls_max <- as.numeric(unlist(x$maxima))
												 ls_peaks <- as.numeric(unlist(x$peaks))
												 
												 rnase_max <- c(ls_max, ls_peaks)
												 rnase_max <- unlist(rnase_max)
												 rnase_max <- rnase_max[rnase_max!=0]
												 rnase_max <- sort(rnase_max, decreasing = FALSE)
												 if (length(rnase_max) == 0) {0} else {rnase_max}
												 })

ctrl_3$ctrl_max <- apply(ctrl_3, 1, function(x) {
												 ls_max <- as.numeric(unlist(x$maxima))
												 ls_peaks <- as.numeric(unlist(x$peaks))
												 
												 ctrl_max <- c(ls_max, ls_peaks)
												 ctrl_max <- unlist(ctrl_max)
												 ctrl_max <- ctrl_max[ctrl_max!=0]
												 ctrl_max <- sort(ctrl_max, decreasing = FALSE)
												 if (length(ctrl_max) == 0) {0} else {ctrl_max}
												 })
```

***********************************************************************************************************
```{r}
# Get the number of maxima for RNASE and CTRL
# New column: "nb_max" (column 29)

rnase_3$nb_max <- apply(rnase_3, 1, function(x) {
												 ls_max <- as.numeric(unlist(x$rnase_max))
												 n = length(ls_max)
												 if (sum(ls_max) == 0) {0} else {n}
												 })
												 
ctrl_3$nb_max <- apply(ctrl_3, 1, function(x) {
												 ls_max <- as.numeric(unlist(x$ctrl_max))
												 n = length(ls_max)
												 if (sum(ls_max) == 0) {0} else {n}
												 })
```

***********************************************************************************************************
#### Gaussian fit of the mean curves (mean of the three replicates per condition)
***********************************************************************************************************
# Addition of new columns in the table ctrl_3 and rnase_3
# Use of the information stored in the table ctrl_norm_mean and rnase_norm_mean
# Function to fit a gaussian on the raw mean data to obtain: fit_c, fit_mean, fit_sigma
# Function to get the residue value: fit_res
# Function to check if the fit was successful: fitted (TRUE/FALSE)

```{r}
# Number of rows of the table - is the total number of proteins
lg <- dim(rnase_3)[1]
# Definition of a matrix with numbers ranging from 1 to lg (matrix with 1 row and lg columns)
vect <- matrix(c(1:lg), 1, lg)
```

```{r}
# Functions to optimize for Gaussian fitting - Gaussians with 1 to 6 peaks
# Each parameter C, mean and sigma will be optimized for each CTRL and RNASE profile
f1 <- function(data, q) {
					C1 <- q[1]
					mean1 <- q[2]
					sigma1 <- q[3]
					res <- (C1 * exp(-(data$y-mean1)**2/(2 * sigma1**2))) - data$df.y
					sum(res * res)
				 }

f2 <- function(data, q) {
					C1 <- q[1]
					mean1 <- q[2]
					sigma1 <- q[3]
					C2 <- q[4]
					mean2 <- q[5]
					sigma2 <- q[6]
					res <- ( C1 * exp(-(data$y-mean1)**2/(2 * sigma1**2)) + C2 * exp(-(data$y-mean2)**2/(2 * sigma2**2)) ) - data$df.y
					sum(res * res)
				 }

f3 <- function(data, q) {
					C1 <- q[1]
					mean1 <- q[2]
					sigma1 <- q[3]
					C2 <- q[4]
					mean2 <- q[5]
					sigma2 <- q[6]
					C3 <- q[7]
					mean3 <- q[8]
					sigma3 <- q[9]
					res <- ( C1 * exp(-(data$y-mean1)**2/(2 * sigma1**2)) + C2 * exp(-(data$y-mean2)**2/(2 * sigma2**2)) + C3 * exp(-(data$y-mean3)**2/(2 * sigma3**2)) ) - data$df.y
					sum(res * res)
				 }

f4 <- function(data, q) {
					C1 <- q[1]
					mean1 <- q[2]
					sigma1 <- q[3]
					C2 <- q[4]
					mean2 <- q[5]
					sigma2 <- q[6]
					C3 <- q[7]
					mean3 <- q[8]
					sigma3 <- q[9]
					C4 <- q[10]
					mean4 <- q[11]
					sigma4 <- q[12]
					res <- ( C1 * exp(-(data$y-mean1)**2/(2 * sigma1**2)) + C2 * exp(-(data$y-mean2)**2/(2 * sigma2**2)) + C3 * exp(-(data$y-mean3)**2/(2 * sigma3**2)) + C4 * exp(-(data$y-mean4)**2/(2 * sigma4**2)) ) - data$df.y
					sum(res * res)
				 }

f5 <- function(data, q) {
					C1 <- q[1]
					mean1 <- q[2]
					sigma1 <- q[3]
					C2 <- q[4]
					mean2 <- q[5]
					sigma2 <- q[6]
					C3 <- q[7]
					mean3 <- q[8]
					sigma3 <- q[9]
					C4 <- q[10]
					mean4 <- q[11]
					sigma4 <- q[12]
					C5 <- q[13]
					mean5 <- q[14]
					sigma5 <- q[15]
					res <- ( C1 * exp(-(data$y-mean1)**2/(2 * sigma1**2)) + C2 * exp(-(data$y-mean2)**2/(2 * sigma2**2)) + C3 * exp(-(data$y-mean3)**2/(2 * sigma3**2)) + C4 * exp(-(data$y-mean4)**2/(2 * sigma4**2)) + C5 * exp(-(data$y-mean5)**2/(2 * sigma5**2)) ) - data$df.y
					sum(res * res)
				 }

f6 <- function(data, q) {
					C1 <- q[1]
					mean1 <- q[2]
					sigma1 <- q[3]
					C2 <- q[4]
					mean2 <- q[5]
					sigma2 <- q[6]
					C3 <- q[7]
					mean3 <- q[8]
					sigma3 <- q[9]
					C4 <- q[10]
					mean4 <- q[11]
					sigma4 <- q[12]
					C5 <- q[13]
					mean5 <- q[14]
					sigma5 <- q[15]
					C6 <- q[16]
					mean6 <- q[17]
					sigma6 <- q[18]
					res <- ( C1 * exp(-(data$y-mean1)**2/(2 * sigma1**2)) + C2 * exp(-(data$y-mean2)**2/(2 * sigma2**2)) + C3 * exp(-(data$y-mean3)**2/(2 * sigma3**2)) + C4 * exp(-(data$y-mean4)**2/(2 * sigma4**2)) + C5 * exp(-(data$y-mean5)**2/(2 * sigma5**2)) + C6 * exp(-(data$y-mean6)**2/(2 * sigma6**2)) ) - data$df.y
					sum(res * res)
				 }
```

***********************************************************************************************************
```{r}
# Fit the RNASE mean curves and get the amplitude of the fit at each peak - new column: fit_c
rnase_3$fit_c <- apply(vect, 2, function(t) {
                          df.y <- c(as.numeric(rnase_norm_mean[t,1:25]))
                          y <- c(1:25)
                          data <- data.frame(y = y, df.y = df.y)
                          Mean_rnase_list <- as.numeric(unlist(rnase_3[t,"rnase_max"]))
                          n <- length(Mean_rnase_list)
                          gauss <- numeric(0)
                          # Before optimization of the parameters, check the number of maxima for the profile of the protein
												  if (n==0) { gauss <- 0 } else {
												  				  								if (n==1) {
												  		  	         									  vector <- c( rnase_norm_mean[t,Mean_rnase_list[1]], Mean_rnase_list[1], 1 )
												  		  	         									  gauss <- tryCatch(round( (fit <- optim(vector, f1, data = data, method="BFGS", control=list(reltol=1e-9)))$par[1],digits = 1 ),error=function(e) numeric(0))
												  				           								  } else {
												  				  												  if (n==2) {
												  				                 											 vector <- c( rnase_norm_mean[t,Mean_rnase_list[1]],Mean_rnase_list[1],1,rnase_norm_mean[t,Mean_rnase_list[2]],Mean_rnase_list[2],1 )
												  				                 											 gauss <- tryCatch(round( (fit <- optim(vector, f2, data = data, method="BFGS", control=list(reltol=1e-9)))$par[c(1,4)],digits = 1 ),error=function(e) numeric(0))
												  	  		                     											 } else {
												  				  																	if (n==3) {
												  				  																			   vector <- c( rnase_norm_mean[t,Mean_rnase_list[1]],Mean_rnase_list[1],1,rnase_norm_mean[t,Mean_rnase_list[2]],Mean_rnase_list[2],1,rnase_norm_mean[t,Mean_rnase_list[3]],Mean_rnase_list[3],1 )
												  				  																			   gauss <- tryCatch(round( (fit <- optim(vector, f3, data = data, method="BFGS", control=list(reltol=1e-9)))$par[c(1,4,7)],digits = 1 ),error=function(e) numeric(0))
												  				 																			   } else {
												  				  																					  if (n==4) {
												  				  																								 vector <- c( rnase_norm_mean[t,Mean_rnase_list[1]],Mean_rnase_list[1],1,rnase_norm_mean[t,Mean_rnase_list[2]],Mean_rnase_list[2],1,rnase_norm_mean[t,Mean_rnase_list[3]],Mean_rnase_list[3],1,rnase_norm_mean[t,Mean_rnase_list[4]],Mean_rnase_list[4],1 )
												  				  																								 gauss <- tryCatch(round( (fit <- optim(vector, f4, data = data, method="BFGS", control=list(reltol=1e-9)))$par[c(1,4,7,10)],digits = 1 ),error=function(e) numeric(0))
												  				  																								 } else {
												                  																										 if (n==5) {
												                  																													vector <- c( rnase_norm_mean[t,Mean_rnase_list[1]],Mean_rnase_list[1],1,rnase_norm_mean[t,Mean_rnase_list[2]],Mean_rnase_list[2],1,rnase_norm_mean[t,Mean_rnase_list[3]],Mean_rnase_list[3],1,rnase_norm_mean[t,Mean_rnase_list[4]],Mean_rnase_list[4],1,rnase_norm_mean[t,Mean_rnase_list[5]],Mean_rnase_list[5],1 )
												                  																													gauss <- tryCatch(round( (fit <- optim(vector, f5, data = data, method="BFGS", control=list(reltol=1e-9)))$par[c(1,4,7,10,13)],digits = 1 ),error=function(e) numeric(0))
												                																													} else {
												                   																														    vector <- c( rnase_norm_mean[t,Mean_rnase_list[1]],Mean_rnase_list[1],1,rnase_norm_mean[t,Mean_rnase_list[2]],Mean_rnase_list[2],1,rnase_norm_mean[t,Mean_rnase_list[3]],Mean_rnase_list[3],1,rnase_norm_mean[t,Mean_rnase_list[4]],Mean_rnase_list[4],1,rnase_norm_mean[t,Mean_rnase_list[5]],Mean_rnase_list[5],1,rnase_norm_mean[t,Mean_rnase_list[6]],Mean_rnase_list[6],1 )
												                   																														    gauss <- tryCatch(round( (fit <- optim(vector, f6, data = data, method="BFGS", control=list(reltol=1e-9)))$par[c(1,4,7,10,13,16)],digits = 1 ),error=function(e) numeric(0))
												                  																															}
												  				  																										 }								
												  				  																						}
												  				  																		}
												  				  												   }
												  				  								}
												  gauss <- unlist(gauss)
												  if (length(gauss) == n) {as.numeric(gauss)} else {0}
												  })
```

***********************************************************************************************************
```{r}
# Fit the RNASE mean curves and get the position of the peak(s) - new column: fit_mean
rnase_3$fit_mean <- apply(vect, 2, function(t) {
												  df.y <- c(as.numeric(rnase_norm_mean[t,1:25]))
												  y <- c(1:25)
												  data <- data.frame(y = y, df.y = df.y)
												  Mean_rnase_list <- as.numeric(unlist(rnase_3[t,"rnase_max"]))
												  n <- length(Mean_rnase_list)
												  gauss <- numeric(0)
										      if (n==0) { gauss <- 0 } else {
												  				  								if (n==1) {
												  		  	         									  vector <- c( rnase_norm_mean[t,Mean_rnase_list[1]], Mean_rnase_list[1], 2 )
												  		  	         									  gauss <- tryCatch(round( (fit <- optim(vector, f1, data = data, method="BFGS", control=list(reltol=1e-9)))$par[2],digits = 1 ),error=function(e) numeric(0))
												  				           								  } else {
												  				  												  if (n==2) {
												  				                 											 vector <- c( rnase_norm_mean[t,Mean_rnase_list[1]],Mean_rnase_list[1],1,rnase_norm_mean[t,Mean_rnase_list[2]],Mean_rnase_list[2],1 )
												  				                 											 gauss <- tryCatch(round( (fit <- optim(vector, f2, data = data, method="BFGS", control=list(reltol=1e-9)))$par[c(2,5)],digits = 1 ),error=function(e) numeric(0))
												  	  		                     											 } else {
												  				  																	if (n==3) {
												  				  																			   vector <- c( rnase_norm_mean[t,Mean_rnase_list[1]],Mean_rnase_list[1],1,rnase_norm_mean[t,Mean_rnase_list[2]],Mean_rnase_list[2],1,rnase_norm_mean[t,Mean_rnase_list[3]],Mean_rnase_list[3],1 )
												  				  																			   gauss <- tryCatch(round( (fit <- optim(vector, f3, data = data, method="BFGS", control=list(reltol=1e-9)))$par[c(2,5,8)],digits = 1 ),error=function(e) numeric(0))
												  				 																			   } else {
												  				  																					  if (n==4) {
												  				  																								 vector <- c( rnase_norm_mean[t,Mean_rnase_list[1]],Mean_rnase_list[1],1,rnase_norm_mean[t,Mean_rnase_list[2]],Mean_rnase_list[2],1,rnase_norm_mean[t,Mean_rnase_list[3]],Mean_rnase_list[3],1,rnase_norm_mean[t,Mean_rnase_list[4]],Mean_rnase_list[4],1 )
												  				  																								 gauss <- tryCatch(round( (fit <- optim(vector, f4, data = data, method="BFGS", control=list(reltol=1e-9)))$par[c(2,5,8,11)],digits = 1 ),error=function(e) numeric(0))
												  				  																								 } else {
												                  																										 if (n==5) {
												                  																													vector <- c( rnase_norm_mean[t,Mean_rnase_list[1]],Mean_rnase_list[1],1,rnase_norm_mean[t,Mean_rnase_list[2]],Mean_rnase_list[2],1,rnase_norm_mean[t,Mean_rnase_list[3]],Mean_rnase_list[3],1,rnase_norm_mean[t,Mean_rnase_list[4]],Mean_rnase_list[4],1,rnase_norm_mean[t,Mean_rnase_list[5]],Mean_rnase_list[5],1 )
												                  																													gauss <- tryCatch(round( (fit <- optim(vector, f5, data = data, method="BFGS", control=list(reltol=1e-9)))$par[c(2,5,8,11,14)],digits = 1 ),error=function(e) numeric(0))
												                																													} else {
												                   																														    vector <- c( rnase_norm_mean[t,Mean_rnase_list[1]],Mean_rnase_list[1],1,rnase_norm_mean[t,Mean_rnase_list[2]],Mean_rnase_list[2],1,rnase_norm_mean[t,Mean_rnase_list[3]],Mean_rnase_list[3],1,rnase_norm_mean[t,Mean_rnase_list[4]],Mean_rnase_list[4],1,rnase_norm_mean[t,Mean_rnase_list[5]],Mean_rnase_list[5],1,rnase_norm_mean[t,Mean_rnase_list[6]],Mean_rnase_list[6],1 )
												                   																														    gauss <- tryCatch(round( (fit <- optim(vector, f6, data = data, method="BFGS", control=list(reltol=1e-9)))$par[c(2,5,8,11,14,17)],digits = 1 ),error=function(e) numeric(0))
												                  																															}
												  				  																										 }								
												  				  																						}
												  				  																		}
												  				  												   }
												  				  								}
												  gauss <- unlist(gauss)
												  if (length(gauss) == n) {as.numeric(gauss)} else {0}
												  })
```

***********************************************************************************************************
```{r}
# Fit the RNASE mean curves and get the covariance (sigma) of the peak(s) - new column: fit_sigma
rnase_3$fit_sigma <- apply(vect, 2, function(t) {
												  df.y <- c(as.numeric(rnase_norm_mean[t,1:25]))
												  y <- c(1:25)
												  data <- data.frame(y = y, df.y = df.y)
												  Mean_rnase_list <- as.numeric(unlist(rnase_3[t,"rnase_max"]))
												  n <- length(Mean_rnase_list)
												  gauss <- numeric(0)
												  if (n==0) { gauss <- 0 } else {
												  				  								if (n==1) {
												  		  	         									  vector <- c( rnase_norm_mean[t,Mean_rnase_list[1]], Mean_rnase_list[1], 2 )
												  		  	         									  gauss <- tryCatch(round( (fit <- optim(vector, f1, data = data, method="BFGS", control=list(reltol=1e-9)))$par[3],digits = 1 ),error=function(e) numeric(0))
												  				           								  } else {
												  				  												  if (n==2) {
												  				                 											 vector <- c( rnase_norm_mean[t,Mean_rnase_list[1]],Mean_rnase_list[1],1,rnase_norm_mean[t,Mean_rnase_list[2]],Mean_rnase_list[2],1 )
												  				                 											 gauss <- tryCatch(round( (fit <- optim(vector, f2, data = data, method="BFGS", control=list(reltol=1e-9)))$par[c(3,6)],digits = 1 ),error=function(e) numeric(0))
												  	  		                     											 } else {
												  				  																	if (n==3) {
												  				  																			   vector <- c( rnase_norm_mean[t,Mean_rnase_list[1]],Mean_rnase_list[1],1,rnase_norm_mean[t,Mean_rnase_list[2]],Mean_rnase_list[2],1,rnase_norm_mean[t,Mean_rnase_list[3]],Mean_rnase_list[3],1 )
												  				  																			   gauss <- tryCatch(round( (fit <- optim(vector, f3, data = data, method="BFGS", control=list(reltol=1e-9)))$par[c(3,6,9)],digits = 1 ),error=function(e) numeric(0))
												  				 																			   } else {
												  				  																					  if (n==4) {
												  				  																								 vector <- c( rnase_norm_mean[t,Mean_rnase_list[1]],Mean_rnase_list[1],1,rnase_norm_mean[t,Mean_rnase_list[2]],Mean_rnase_list[2],1,rnase_norm_mean[t,Mean_rnase_list[3]],Mean_rnase_list[3],1,rnase_norm_mean[t,Mean_rnase_list[4]],Mean_rnase_list[4],1 )
												  				  																								 gauss <- tryCatch(round( (fit <- optim(vector, f4, data = data, method="BFGS", control=list(reltol=1e-9)))$par[c(3,6,9,12)],digits = 1 ),error=function(e) numeric(0))
												  				  																								 } else {
												                  																										 if (n==5) {
												                  																													vector <- c( rnase_norm_mean[t,Mean_rnase_list[1]],Mean_rnase_list[1],1,rnase_norm_mean[t,Mean_rnase_list[2]],Mean_rnase_list[2],1,rnase_norm_mean[t,Mean_rnase_list[3]],Mean_rnase_list[3],1,rnase_norm_mean[t,Mean_rnase_list[4]],Mean_rnase_list[4],1,rnase_norm_mean[t,Mean_rnase_list[5]],Mean_rnase_list[5],1 )
												                  																													gauss <- tryCatch(round( (fit <- optim(vector, f5, data = data, method="BFGS", control=list(reltol=1e-9)))$par[c(3,6,9,12,15)],digits = 1 ),error=function(e) numeric(0))
												                																													} else {
												                   																														    vector <- c( rnase_norm_mean[t,Mean_rnase_list[1]],Mean_rnase_list[1],1,rnase_norm_mean[t,Mean_rnase_list[2]],Mean_rnase_list[2],1,rnase_norm_mean[t,Mean_rnase_list[3]],Mean_rnase_list[3],1,rnase_norm_mean[t,Mean_rnase_list[4]],Mean_rnase_list[4],1,rnase_norm_mean[t,Mean_rnase_list[5]],Mean_rnase_list[5],1,rnase_norm_mean[t,Mean_rnase_list[6]],Mean_rnase_list[6],1 )
												                   																														    gauss <- tryCatch(round( (fit <- optim(vector, f6, data = data, method="BFGS", control=list(reltol=1e-9)))$par[c(3,6,9,12,15,18)],digits = 1 ),error=function(e) numeric(0))
												                  																															}
												  				  																										 }								
												  				  																						}
												  				  																		}
												  				  												   }
												  				  								}
												  gauss <- unlist(gauss)
												  if (length(gauss) == n) {as.numeric(gauss)} else {0}
												  })
```

***********************************************************************************************************
```{r}
# Fit the RNASE mean curves and get the residual sum of the squares - new column: fit_res
rnase_3$fit_res <- apply(vect, 2, function(t) {
												  df.y <- c(as.numeric(rnase_norm_mean[t,1:25]))
												  y <- c(1:25)
												  data <- data.frame(y = y, df.y = df.y)
												  Mean_rnase_list <- as.numeric(unlist(rnase_3[t,"rnase_max"]))
												  n <- length(Mean_rnase_list)
												  gauss <- numeric(0)
                          if (n==0) { gauss <- 0 } else {
												  				  								if (n==1) {
												  		  	         									  vector <- c( rnase_norm_mean[t,Mean_rnase_list[1]], Mean_rnase_list[1], 1 )
												  		  	         									  gauss <- tryCatch(round( (fit <- optim(vector, f1, data = data, method="BFGS", control=list(reltol=1e-9)))$value,digits = 1 ),error=function(e) numeric(0))
												  				           								  } else {
												  				  												  if (n==2) {
												  				                 											 vector <- c( rnase_norm_mean[t,Mean_rnase_list[1]],Mean_rnase_list[1],1,rnase_norm_mean[t,Mean_rnase_list[2]],Mean_rnase_list[2],1 )
												  				                 											 gauss <- tryCatch(round( (fit <- optim(vector, f2, data = data, method="BFGS", control=list(reltol=1e-9)))$value,digits = 1 ),error=function(e) numeric(0))
												  	  		                     											 } else {
												  				  																	if (n==3) {
												  				  																			   vector <- c( rnase_norm_mean[t,Mean_rnase_list[1]],Mean_rnase_list[1],1,rnase_norm_mean[t,Mean_rnase_list[2]],Mean_rnase_list[2],1,rnase_norm_mean[t,Mean_rnase_list[3]],Mean_rnase_list[3],1 )
												  				  																			   gauss <- tryCatch(round( (fit <- optim(vector, f3, data = data, method="BFGS", control=list(reltol=1e-9)))$value,digits = 1 ),error=function(e) numeric(0))
												  				 																			   } else {
												  				  																					  if (n==4) {
												  				  																								 vector <- c( rnase_norm_mean[t,Mean_rnase_list[1]],Mean_rnase_list[1],1,rnase_norm_mean[t,Mean_rnase_list[2]],Mean_rnase_list[2],1,rnase_norm_mean[t,Mean_rnase_list[3]],Mean_rnase_list[3],1,rnase_norm_mean[t,Mean_rnase_list[4]],Mean_rnase_list[4],1 )
												  				  																								 gauss <- tryCatch(round( (fit <- optim(vector, f4, data = data, method="BFGS", control=list(reltol=1e-9)))$value,digits = 1 ),error=function(e) numeric(0))
												  				  																								 } else {
												                  																										 if (n==5) {
												                  																													vector <- c( rnase_norm_mean[t,Mean_rnase_list[1]],Mean_rnase_list[1],1,rnase_norm_mean[t,Mean_rnase_list[2]],Mean_rnase_list[2],1,rnase_norm_mean[t,Mean_rnase_list[3]],Mean_rnase_list[3],1,rnase_norm_mean[t,Mean_rnase_list[4]],Mean_rnase_list[4],1,rnase_norm_mean[t,Mean_rnase_list[5]],Mean_rnase_list[5],1 )
												                  																													gauss <- tryCatch(round( (fit <- optim(vector, f5, data = data, method="BFGS", control=list(reltol=1e-9)))$value,digits = 1 ),error=function(e) numeric(0))
												                																													} else {
												                   																														    vector <- c( rnase_norm_mean[t,Mean_rnase_list[1]],Mean_rnase_list[1],1,rnase_norm_mean[t,Mean_rnase_list[2]],Mean_rnase_list[2],1,rnase_norm_mean[t,Mean_rnase_list[3]],Mean_rnase_list[3],1,rnase_norm_mean[t,Mean_rnase_list[4]],Mean_rnase_list[4],1,rnase_norm_mean[t,Mean_rnase_list[5]],Mean_rnase_list[5],1,rnase_norm_mean[t,Mean_rnase_list[6]],Mean_rnase_list[6],1 )
												                   																														    gauss <- tryCatch(round( (fit <- optim(vector, f6, data = data, method="BFGS", control=list(reltol=1e-9)))$value,digits = 1 ),error=function(e) numeric(0))
												                  																															}
												  				  																										 }								
												  				  																						}
												  				  																		}
												  				  												   }
												  				  								}
												  gauss <- unlist(gauss)
												  if (length(gauss) == 1) {as.numeric(gauss)} else {0}
												  })
```

***********************************************************************************************************
```{r}
# Check whether a fit curve could be found or not for the protein - new column: fitted
rnase_3$fitted <- apply(rnase_3, 1, function(x) { 
																				 list_c <- as.numeric(unlist(x$fit_c))
																				 list_m <- as.numeric(unlist(x$fit_mean))
																				 list_s <- as.numeric(unlist(x$fit_sigma))
																				 list <- c(list_c, list_m, list_s)
																				 
																				 if (sum(list) == 0) {FALSE} else {TRUE}
																				 })
```

***********************************************************************************************************
# Repeat the same with the CTRL condition
***********************************************************************************************************
```{r}
# Fit the CTRL mean curves and get the amplitude of the fit at each peak - new column: fit_c
ctrl_3$fit_c <- apply(vect, 2, function(t) {
  
  df.y <- c(as.numeric(rnase_norm_mean[t,1:25]))
                          df.y <- c(as.numeric(ctrl_norm_mean[t,1:25]))
												  y <- c(1:25)
												  data <- data.frame(y = y, df.y = df.y)
												  Mean_ctrl_list <- as.numeric(unlist(ctrl_3[t,"ctrl_max"]))
												  n <- length(Mean_ctrl_list)
												  gauss <- numeric(0)
												  if (n==0) { gauss <- 0 } else {
												  				  								if (n==1) {
												  		  	         									  vector <- c( ctrl_norm_mean[t,Mean_ctrl_list[1]], Mean_ctrl_list[1], 1 )
												  		  	         									  gauss <- tryCatch(round( (fit <- optim(vector, f1, data = data, method="BFGS", control=list(reltol=1e-9)))$par[1],digits = 1 ),error=function(e) numeric(0))
												  				           								  } else {
												  				  												  if (n==2) {
												  				                 											 vector <- c( ctrl_norm_mean[t,Mean_ctrl_list[1]],Mean_ctrl_list[1],1,ctrl_norm_mean[t,Mean_ctrl_list[2]],Mean_ctrl_list[2],1 )
												  				                 											 gauss <- tryCatch(round( (fit <- optim(vector, f2, data = data, method="BFGS", control=list(reltol=1e-9)))$par[c(1,4)],digits = 1 ),error=function(e) numeric(0))
												  	  		                     											 } else {
												  				  																	if (n==3) {
												  				  																			   vector <- c( ctrl_norm_mean[t,Mean_ctrl_list[1]],Mean_ctrl_list[1],1,ctrl_norm_mean[t,Mean_ctrl_list[2]],Mean_ctrl_list[2],1,ctrl_norm_mean[t,Mean_ctrl_list[3]],Mean_ctrl_list[3],1 )
												  				  																			   gauss <- tryCatch(round( (fit <- optim(vector, f3, data = data, method="BFGS", control=list(reltol=1e-9)))$par[c(1,4,7)],digits = 1 ),error=function(e) numeric(0))
												  				 																			   } else {
												  				  																					  if (n==4) {
												  				  																								 vector <- c( ctrl_norm_mean[t,Mean_ctrl_list[1]],Mean_ctrl_list[1],1,ctrl_norm_mean[t,Mean_ctrl_list[2]],Mean_ctrl_list[2],1,ctrl_norm_mean[t,Mean_ctrl_list[3]],Mean_ctrl_list[3],1,ctrl_norm_mean[t,Mean_ctrl_list[4]],Mean_ctrl_list[4],1 )
												  				  																								 gauss <- tryCatch(round( (fit <- optim(vector, f4, data = data, method="BFGS", control=list(reltol=1e-9)))$par[c(1,4,7,10)],digits = 1 ),error=function(e) numeric(0))
												  				  																								 } else {
												                  																										 if (n==5) {
												                  																													vector <- c( ctrl_norm_mean[t,Mean_ctrl_list[1]],Mean_ctrl_list[1],1,ctrl_norm_mean[t,Mean_ctrl_list[2]],Mean_ctrl_list[2],1,ctrl_norm_mean[t,Mean_ctrl_list[3]],Mean_ctrl_list[3],1,ctrl_norm_mean[t,Mean_ctrl_list[4]],Mean_ctrl_list[4],1,ctrl_norm_mean[t,Mean_ctrl_list[5]],Mean_ctrl_list[5],1 )
												                  																													gauss <- tryCatch(round( (fit <- optim(vector, f5, data = data, method="BFGS", control=list(reltol=1e-9)))$par[c(1,4,7,10,13)],digits = 1 ),error=function(e) numeric(0))
												                																													} else {
												                   																														    vector <- c( ctrl_norm_mean[t,Mean_ctrl_list[1]],Mean_ctrl_list[1],1,ctrl_norm_mean[t,Mean_ctrl_list[2]],Mean_ctrl_list[2],1,ctrl_norm_mean[t,Mean_ctrl_list[3]],Mean_ctrl_list[3],1,ctrl_norm_mean[t,Mean_ctrl_list[4]],Mean_ctrl_list[4],1,ctrl_norm_mean[t,Mean_ctrl_list[5]],Mean_ctrl_list[5],1,ctrl_norm_mean[t,Mean_ctrl_list[6]],Mean_ctrl_list[6],1 )
												                   																														    gauss <- tryCatch(round( (fit <- optim(vector, f6, data = data, method="BFGS", control=list(reltol=1e-9)))$par[c(1,4,7,10,13,16)],digits = 1 ),error=function(e) numeric(0))
												                  																															}
												  				  																										 }								
												  				  																						}
												  				  																		}
												  				  												   }
												  				  								}
												  gauss <- unlist(gauss)
												  if (length(gauss) == n) {as.numeric(gauss)} else {0}
												  })
```

***********************************************************************************************************
```{r}
# Fit the CTRL mean curves and get the position of the peak(s) - new column: fit_mean
ctrl_3$fit_mean <- apply(vect, 2, function(t) {
												  df.y <- c(as.numeric(ctrl_norm_mean[t,1:25]))
												  y <- c(1:25)
												  data <- data.frame(y = y, df.y = df.y)
												  Mean_ctrl_list <- as.numeric(unlist(ctrl_3[t,"ctrl_max"]))
												  n <- length(Mean_ctrl_list)
												  gauss <- numeric(0)
												  if (n==0) { gauss <- 0 } else {
												  				  								if (n==1) {
												  		  	         									  vector <- c( ctrl_norm_mean[t,Mean_ctrl_list[1]], Mean_ctrl_list[1], 1 )
												  		  	         									  gauss <- tryCatch(round( (fit <- optim(vector, f1, data = data, method="BFGS", control=list(reltol=1e-9)))$par[2],digits = 1 ),error=function(e) numeric(0))
												  				           								  } else {
												  				  												  if (n==2) {
												  				                 											 vector <- c( ctrl_norm_mean[t,Mean_ctrl_list[1]],Mean_ctrl_list[1],1,ctrl_norm_mean[t,Mean_ctrl_list[2]],Mean_ctrl_list[2],1 )
												  				                 											 gauss <- tryCatch(round( (fit <- optim(vector, f2, data = data, method="BFGS", control=list(reltol=1e-9)))$par[c(2,5)],digits = 1 ),error=function(e) numeric(0))
												  	  		                     											 } else {
												  				  																	if (n==3) {
												  				  																			   vector <- c( ctrl_norm_mean[t,Mean_ctrl_list[1]],Mean_ctrl_list[1],1,ctrl_norm_mean[t,Mean_ctrl_list[2]],Mean_ctrl_list[2],1,ctrl_norm_mean[t,Mean_ctrl_list[3]],Mean_ctrl_list[3],1 )
												  				  																			   gauss <- tryCatch(round( (fit <- optim(vector, f3, data = data, method="BFGS", control=list(reltol=1e-9)))$par[c(2,5,8)],digits = 1 ),error=function(e) numeric(0))
												  				 																			   } else {
												  				  																					  if (n==4) {
												  				  																								 vector <- c( ctrl_norm_mean[t,Mean_ctrl_list[1]],Mean_ctrl_list[1],1,ctrl_norm_mean[t,Mean_ctrl_list[2]],Mean_ctrl_list[2],1,ctrl_norm_mean[t,Mean_ctrl_list[3]],Mean_ctrl_list[3],1,ctrl_norm_mean[t,Mean_ctrl_list[4]],Mean_ctrl_list[4],1 )
												  				  																								 gauss <- tryCatch(round( (fit <- optim(vector, f4, data = data, method="BFGS", control=list(reltol=1e-9)))$par[c(2,5,8,11)],digits = 1 ),error=function(e) numeric(0))
												  				  																								 } else {
												                  																										 if (n==5) {
												                  																													vector <- c( ctrl_norm_mean[t,Mean_ctrl_list[1]],Mean_ctrl_list[1],1,ctrl_norm_mean[t,Mean_ctrl_list[2]],Mean_ctrl_list[2],1,ctrl_norm_mean[t,Mean_ctrl_list[3]],Mean_ctrl_list[3],1,ctrl_norm_mean[t,Mean_ctrl_list[4]],Mean_ctrl_list[4],1,ctrl_norm_mean[t,Mean_ctrl_list[5]],Mean_ctrl_list[5],1 )
												                  																													gauss <- tryCatch(round( (fit <- optim(vector, f5, data = data, method="BFGS", control=list(reltol=1e-9)))$par[c(2,5,8,11,14)],digits = 1 ),error=function(e) numeric(0))
												                																													} else {
												                   																														    vector <- c( ctrl_norm_mean[t,Mean_ctrl_list[1]],Mean_ctrl_list[1],1,ctrl_norm_mean[t,Mean_ctrl_list[2]],Mean_ctrl_list[2],1,ctrl_norm_mean[t,Mean_ctrl_list[3]],Mean_ctrl_list[3],1,ctrl_norm_mean[t,Mean_ctrl_list[4]],Mean_ctrl_list[4],1,ctrl_norm_mean[t,Mean_ctrl_list[5]],Mean_ctrl_list[5],1,ctrl_norm_mean[t,Mean_ctrl_list[6]],Mean_ctrl_list[6],1 )
												                   																														    gauss <- tryCatch(round( (fit <- optim(vector, f6, data = data, method="BFGS", control=list(reltol=1e-9)))$par[c(2,5,8,11,14,17)],digits = 1 ),error=function(e) numeric(0))
												                  																															}
												  				  																										 }								
												  				  																						}
												  				  																		}
												  				  												   }
												  				  								}
												  gauss <- unlist(gauss)
												  if (length(gauss) == n) {as.numeric(gauss)} else {0}
												  })
```

***********************************************************************************************************
```{r}
# Fit the CTRL mean curves and get the covariance (sigma) of the peak(s) - new column: fit_sigma
ctrl_3$fit_sigma <- apply(vect, 2, function(t) {
												  df.y <- c(as.numeric(ctrl_norm_mean[t,1:25]))
												  y <- c(1:25)
												  data <- data.frame(y = y, df.y = df.y)
												  Mean_ctrl_list <- as.numeric(unlist(ctrl_3[t,"ctrl_max"]))
												  n <- length(Mean_ctrl_list)
												  gauss <- numeric(0)
												  if (n==0) { gauss <- 0 } else {
												  				  								if (n==1) {
												  		  	         									  vector <- c( ctrl_norm_mean[t,Mean_ctrl_list[1]], Mean_ctrl_list[1], 1 )
												  		  	         									  gauss <- tryCatch(round( (fit <- optim(vector, f1, data = data, method="BFGS", control=list(reltol=1e-9)))$par[3],digits = 1 ),error=function(e) numeric(0))
												  				           								  } else {
												  				  												  if (n==2) {
												  				                 											 vector <- c( ctrl_norm_mean[t,Mean_ctrl_list[1]],Mean_ctrl_list[1],1,ctrl_norm_mean[t,Mean_ctrl_list[2]],Mean_ctrl_list[2],1 )
												  				                 											 gauss <- tryCatch(round( (fit <- optim(vector, f2, data = data, method="BFGS", control=list(reltol=1e-9)))$par[c(3,6)],digits = 1 ),error=function(e) numeric(0))
												  	  		                     											 } else {
												  				  																	if (n==3) {
												  				  																			   vector <- c( ctrl_norm_mean[t,Mean_ctrl_list[1]],Mean_ctrl_list[1],1,ctrl_norm_mean[t,Mean_ctrl_list[2]],Mean_ctrl_list[2],1,ctrl_norm_mean[t,Mean_ctrl_list[3]],Mean_ctrl_list[3],1 )
												  				  																			   gauss <- tryCatch(round( (fit <- optim(vector, f3, data = data, method="BFGS", control=list(reltol=1e-9)))$par[c(3,6,9)],digits = 1 ),error=function(e) numeric(0))
												  				 																			   } else {
												  				  																					  if (n==4) {
												  				  																								 vector <- c( ctrl_norm_mean[t,Mean_ctrl_list[1]],Mean_ctrl_list[1],1,ctrl_norm_mean[t,Mean_ctrl_list[2]],Mean_ctrl_list[2],1,ctrl_norm_mean[t,Mean_ctrl_list[3]],Mean_ctrl_list[3],1,ctrl_norm_mean[t,Mean_ctrl_list[4]],Mean_ctrl_list[4],1 )
												  				  																								 gauss <- tryCatch(round( (fit <- optim(vector, f4, data = data, method="BFGS", control=list(reltol=1e-9)))$par[c(3,6,9,12)],digits = 1 ),error=function(e) numeric(0))
												  				  																								 } else {
												                  																										 if (n==5) {
												                  																													vector <- c( ctrl_norm_mean[t,Mean_ctrl_list[1]],Mean_ctrl_list[1],1,ctrl_norm_mean[t,Mean_ctrl_list[2]],Mean_ctrl_list[2],1,ctrl_norm_mean[t,Mean_ctrl_list[3]],Mean_ctrl_list[3],1,ctrl_norm_mean[t,Mean_ctrl_list[4]],Mean_ctrl_list[4],1,ctrl_norm_mean[t,Mean_ctrl_list[5]],Mean_ctrl_list[5],1 )
												                  																													gauss <- tryCatch(round( (fit <- optim(vector, f5, data = data, method="BFGS", control=list(reltol=1e-9)))$par[c(3,6,9,12,15)],digits = 1 ),error=function(e) numeric(0))
												                																													} else {
												                   																														    vector <- c( ctrl_norm_mean[t,Mean_ctrl_list[1]],Mean_ctrl_list[1],1,ctrl_norm_mean[t,Mean_ctrl_list[2]],Mean_ctrl_list[2],1,ctrl_norm_mean[t,Mean_ctrl_list[3]],Mean_ctrl_list[3],1,ctrl_norm_mean[t,Mean_ctrl_list[4]],Mean_ctrl_list[4],1,ctrl_norm_mean[t,Mean_ctrl_list[5]],Mean_ctrl_list[5],1,ctrl_norm_mean[t,Mean_ctrl_list[6]],Mean_ctrl_list[6],1 )
												                   																														    gauss <- tryCatch(round( (fit <- optim(vector, f6, data = data, method="BFGS", control=list(reltol=1e-9)))$par[c(3,6,9,12,15,18)],digits = 1 ),error=function(e) numeric(0))
												                  																															}
												  				  																										 }								
												  				  																						}
												  				  																		}
												  				  												   }
												  				  								}
												  gauss <- unlist(gauss)
												  if (length(gauss) == n) {as.numeric(gauss)} else {0}
												  })
```

***********************************************************************************************************
```{r}
# Fit the CTRL mean curves and get the residual sum of the squares - new column: fit_res
ctrl_3$fit_res <- apply(vect, 2, function(t) {
												  df.y <- c(as.numeric(ctrl_norm_mean[t,1:25]))
												  y <- c(1:25)
												  data <- data.frame(y = y, df.y = df.y)
												  Mean_ctrl_list <- as.numeric(unlist(ctrl_3[t,"ctrl_max"]))
												  n <- length(Mean_ctrl_list)
												  gauss <- numeric(0)
												  if (n==0) { gauss <- 0 } else {
												  				  								if (n==1) {
												  		  	         									  vector <- c( ctrl_norm_mean[t,Mean_ctrl_list[1]], Mean_ctrl_list[1], 1 )
												  		  	         									  gauss <- tryCatch(round( (fit <- optim(vector, f1, data = data, method="BFGS", control=list(reltol=1e-9)))$value,digits = 1 ),error=function(e) numeric(0))
												  				           								  } else {
												  				  												  if (n==2) {
												  				                 											 vector <- c( ctrl_norm_mean[t,Mean_ctrl_list[1]],Mean_ctrl_list[1],1,ctrl_norm_mean[t,Mean_ctrl_list[2]],Mean_ctrl_list[2],1 )
												  				                 											 gauss <- tryCatch(round( (fit <- optim(vector, f2, data = data, method="BFGS", control=list(reltol=1e-9)))$value,digits = 1 ),error=function(e) numeric(0))
												  	  		                     											 } else {
												  				  																	if (n==3) {
												  				  																			   vector <- c( ctrl_norm_mean[t,Mean_ctrl_list[1]],Mean_ctrl_list[1],1,ctrl_norm_mean[t,Mean_ctrl_list[2]],Mean_ctrl_list[2],1,ctrl_norm_mean[t,Mean_ctrl_list[3]],Mean_ctrl_list[3],1 )
												  				  																			   gauss <- tryCatch(round( (fit <- optim(vector, f3, data = data, method="BFGS", control=list(reltol=1e-9)))$value,digits = 1 ),error=function(e) numeric(0))
												  				 																			   } else {
												  				  																					  if (n==4) {
												  				  																								 vector <- c( ctrl_norm_mean[t,Mean_ctrl_list[1]],Mean_ctrl_list[1],1,ctrl_norm_mean[t,Mean_ctrl_list[2]],Mean_ctrl_list[2],1,ctrl_norm_mean[t,Mean_ctrl_list[3]],Mean_ctrl_list[3],1,ctrl_norm_mean[t,Mean_ctrl_list[4]],Mean_ctrl_list[4],1 )
												  				  																								 gauss <- tryCatch(round( (fit <- optim(vector, f4, data = data, method="BFGS", control=list(reltol=1e-9)))$value,digits = 1 ),error=function(e) numeric(0))
												  				  																								 } else {
												                  																										 if (n==5) {
												                  																													vector <- c( ctrl_norm_mean[t,Mean_ctrl_list[1]],Mean_ctrl_list[1],1,ctrl_norm_mean[t,Mean_ctrl_list[2]],Mean_ctrl_list[2],1,ctrl_norm_mean[t,Mean_ctrl_list[3]],Mean_ctrl_list[3],1,ctrl_norm_mean[t,Mean_ctrl_list[4]],Mean_ctrl_list[4],1,ctrl_norm_mean[t,Mean_ctrl_list[5]],Mean_ctrl_list[5],1 )
												                  																													gauss <- tryCatch(round( (fit <- optim(vector, f5, data = data, method="BFGS", control=list(reltol=1e-9)))$value,digits = 1 ),error=function(e) numeric(0))
												                																													} else {
												                   																														    vector <- c( ctrl_norm_mean[t,Mean_ctrl_list[1]],Mean_ctrl_list[1],1,ctrl_norm_mean[t,Mean_ctrl_list[2]],Mean_ctrl_list[2],1,ctrl_norm_mean[t,Mean_ctrl_list[3]],Mean_ctrl_list[3],1,ctrl_norm_mean[t,Mean_ctrl_list[4]],Mean_ctrl_list[4],1,ctrl_norm_mean[t,Mean_ctrl_list[5]],Mean_ctrl_list[5],1,ctrl_norm_mean[t,Mean_ctrl_list[6]],Mean_ctrl_list[6],1 )
												                   																														    gauss <- tryCatch(round( (fit <- optim(vector, f6, data = data, method="BFGS", control=list(reltol=1e-9)))$value,digits = 1 ),error=function(e) numeric(0))
												                  																															}
												  				  																										 }								
												  				  																						}
												  				  																		}
												  				  												   }
												  				  								}
												  gauss <- unlist(gauss)
												  if (length(gauss) == 1) {as.numeric(gauss)} else {0}
												  })
```

***********************************************************************************************************
```{r}
# Check whether a fit curve could be found or not for the protein - new column: fitted
ctrl_3$fitted <- apply(ctrl_3, 1, function(x) { 
																				 list_c <- as.numeric(unlist(x$fit_c))
																				 list_m <- as.numeric(unlist(x$fit_mean))
																				 list_s <- as.numeric(unlist(x$fit_sigma))
																				 list <- c(list_c, list_m, list_s)
																				 
																				 if (sum(list) == 0) {FALSE} else {TRUE}
																				 })	
```

***********************************************************************************************************
```{r}
# Control that the mean values are sorted.
# Fit_c and fit_sigma need to be sorted accordingly.
# Create a sorted parameters vector - new column: fit_param

ctrl_3$fit_param <- apply(vect, 2, function(z) {
												# Get the parameters after fitting
                        list_c <- as.numeric(unlist(ctrl_3[z,"fit_c"]))
												list_mean <- as.numeric(unlist(ctrl_3[z,"fit_mean"]))
												list_sigma <- as.numeric(unlist(ctrl_3[z,"fit_sigma"]))
												n <- length(list_c)
												vector <- numeric(0)
												
												# Sort the parameters
												if ((n==1) && c(list_c, list_mean, list_sigma) == c(0,0,0)) {fit_param <- c(0,0,0)} else { fit_param <- as.data.frame(matrix( c(list_c, list_mean, list_sigma),n,3,byrow="FALSE" ))
																																 fit_param <- fit_param[order(fit_param$V2),]
																																 fit_param <- unlist(fit_param)
																																 }
												fit_param
												})


rnase_3$fit_param <- apply(vect, 2, function(z) {
                        # Get the parameters after fitting
												list_c <- as.numeric(unlist(rnase_3[z,"fit_c"]))
												list_mean <- as.numeric(unlist(rnase_3[z,"fit_mean"]))
												list_sigma <- as.numeric(unlist(rnase_3[z,"fit_sigma"]))
												n <- length(list_c)
												vector <- numeric(0)
												
												# Sort the parameters
												if ((n==1) && c(list_c, list_mean, list_sigma) == c(0,0,0)) {fit_param <- c(0,0,0)} else { fit_param <- as.data.frame(matrix( c(list_c, list_mean, list_sigma),n,3,byrow="FALSE" ))
																																 fit_param <- fit_param[order(fit_param$V2),]
																																 fit_param <- unlist(fit_param)
																																 }
												fit_param
												})
```

***********************************************************************************************************
```{r}
# Take care of the edges (for fitted mean <1 or >25).
# Set the fraction to min 1 and max 25.
# Calculate accordingly the amplitude of the fit at these positions.

ctrl_3$fit_mean_fxn <- apply(vect, 2, function(z) {
												   fit_param <- as.numeric(unlist(ctrl_3[z,"fit_param"]))
												   n <- length(fit_param)/3
												   fit_param <- as.data.frame(matrix( fit_param,n,3,byrow="FALSE" ))
												   list_c <- unlist(fit_param[,1])
												   list_mean <- unlist(fit_param[,2])
												   list_sigma <- unlist(fit_param[,3])
												   
												   if (list_mean[n] > 25) {list_mean[n] <- 25}
												   if (list_mean[1] < 1) {list_mean[1] <- 1}
												   unlist(list_mean)
												   if (ctrl_3[z,"fitted"] == "FALSE") {0} else {list_mean}
												   })
												   

ctrl_3$fit_c_fxn <- apply(vect, 2, function(z) {
												   fit_param <- as.numeric(unlist(ctrl_3[z,"fit_param"]))
												   n <- length(fit_param)/3
												   fit_param <- as.data.frame(matrix( fit_param,n,3,byrow="FALSE" ))
												   list_c <- unlist(fit_param[,1])
												   list_mean <- unlist(fit_param[,2])
												   list_sigma <- unlist(fit_param[,3])
												   
												   if (list_mean[n] > 25) {
												   						   q <- c(list_c[n],list_mean[n],list_sigma[n])
															 			   list_c[n] <- (q[1] * exp(-(25-q[2])**2/(2 * q[3]**2)))
												   						   }
												   list_mean[n] <- 25
												   if (list_mean[1] < 1) {
												   						  q <- c(list_c[1],list_mean[1],list_sigma[1])
															 			  list_c[1] <- (q[1] * exp(-(1-q[2])**2/(2 * q[3]**2)))
												   						  }
												   unlist(list_c)
												   list_c
												   })												   
												   

rnase_3$fit_mean_fxn <- apply(vect, 2, function(z) {
												   fit_param <- as.numeric(unlist(rnase_3[z,"fit_param"]))
												   n <- length(fit_param)/3
												   fit_param <- as.data.frame(matrix( fit_param,n,3,byrow="FALSE" ))
												   list_c <- unlist(fit_param[,1])
												   list_mean <- unlist(fit_param[,2])
												   list_sigma <- unlist(fit_param[,3])
												   
												   if (list_mean[n] > 25) {list_mean[n] <- 25}
												   if (list_mean[1] < 1) {list_mean[1] <- 1}
												   unlist(list_mean)
												   if (rnase_3[z,"fitted"] == "FALSE") {0} else {list_mean}
												   })
												   

rnase_3$fit_c_fxn <- apply(vect, 2, function(z) {
												   fit_param <- as.numeric(unlist(rnase_3[z,"fit_param"]))
												   n <- length(fit_param)/3
												   fit_param <- as.data.frame(matrix( fit_param,n,3,byrow="FALSE" ))
												   list_c <- unlist(fit_param[,1])
												   list_mean <- unlist(fit_param[,2])
												   list_sigma <- unlist(fit_param[,3])
												   
												   if (list_mean[n] > 25) {
												   						   q <- c(list_c[n],list_mean[n],list_sigma[n])
															 			   list_c[n] <- (q[1] * exp(-(25-q[2])**2/(2 * q[3]**2)))
												   						   }
												   list_mean[n] <- 25
												   if (list_mean[1] < 1) {
												   						  q <- c(list_c[1],list_mean[1],list_sigma[1])
															 			  list_c[1] <- (q[1] * exp(-(1-q[2])**2/(2 * q[3]**2)))
												   						  }
												   unlist(list_c)
												   list_c
												   })
```

***********************************************************************************************************
3 - Gaussian fit on each curve (per protein, three control and three Rnase replicates)
***********************************************************************************************************